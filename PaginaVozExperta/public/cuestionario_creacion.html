<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Creación de Cuestionario</title>
  <link rel="stylesheet" href="styleCC.css">
</head>
<body>
  <div class="form-container">
    <h2>Crear nuevo cuestionario</h2>

    <label for="nombre-cuestionario">Nombre del cuestionario</label>
    <input type="text" id="nombre-cuestionario" name="nombre-cuestionario" required>
    <div>
      <label for="umbral-cuestionario">Umbral de aceptación:</label>
      <select id="umbral-cuestionario" name="umbral">
        <option value=1>1</option>
        <option value=1.5>1.5</option>
        <option value=2>2</option>
        <option value=2.5>2.5</option>
        <option value=3>3</option>
        <option value=3.5>3.5</option>
        <option value=4>4</option>
        <option value=4.5>4.5</option>
        <option value=5>5</option>
      </select><br><br>
    </div>

    <label for="fechaApertura">Fecha de apertura:</label>
    <input type="date" id="fechaApertura" required>

    <label for="fechaCierre">Fecha de cierre:</label>
    <input type="date" id="fechaCierre" required>

    <form id="dynamic-form" onsubmit="handleFormSubmit(event)">
      <div id="questions-container">
        <!-- Las preguntas se añadirán aquí dinámicamente -->
      </div>

      <button type="button" class="add-question-btn" onclick="addQuestion()">Añadir Pregunta</button>
      <button type="submit">Enviar Cuestionario</button>
    </form>
  </div>

  <script>
    function addQuestion() {
      const container = document.getElementById('questions-container');
      const block = document.createElement('div');
      block.className = 'question-block';
      block.innerHTML = `
        <hr>
        <label>Texto de la pregunta:</label>
        <input type="text" name="questionText" required>

        <label>Tipo de respuesta:</label>
        <select name="answerType" onchange="toggleOptions(this)">
          <option value="text">Texto libre</option>
          <option value="multiple">Opción múltiple</option>
          <option value="scale">Escala 1-5</option>
          <option value="matrix">Matriz 1-5</option>
        </select>

        <div class="options-container" style="display:none">
          <label>Opciones:</label>
          <div class="option-list">
            <input type="text" class="option-input" placeholder="Opción 1">
            <input type="text" class="option-input" placeholder="Opción 2">
          </div>
          <button type="button" onclick="addOption(this)">Añadir Opción</button>
        </div>
        <button type="button" class="remove-question-btn" onclick="removeQuestion(this.parentElement)">Eliminar Pregunta</button>
      `;
      
      container.appendChild(block);
    }

    function toggleOptions(selectElement) {
      const optionsDiv = selectElement.parentElement.querySelector('.options-container');
      if (selectElement.value === 'multiple') {
        optionsDiv.style.display = 'block';
      } else {
        optionsDiv.style.display = 'none';
      }
    }

    function addOption(button) {
      const container = button.parentElement.querySelector('.option-list');
      const input = document.createElement('input');
      input.type = 'text';
      input.className = 'option-input';
      input.placeholder = `Opción ${container.children.length + 1}`;
      container.appendChild(input);
    }
    function removeQuestion(questionDiv) {
      questionDiv.remove();
    }

    function handleFormSubmit(event) {
      event.preventDefault();

      const nombre = document.getElementById('nombre-cuestionario').value.trim();
      const fechaApertura = document.getElementById('fechaApertura').value;
      const fechaCierre = document.getElementById('fechaCierre').value;
      const Umbral = Number(document.getElementById('umbral-cuestionario').value);

      if (!nombre || !fechaApertura || !fechaCierre) {
        alert("Por favor completa el nombre del cuestionario y las fechas.");
        return;
      }

      const preguntas = [];
      document.querySelectorAll('.question-block').forEach(block => {
        const texto = block.querySelector('input[name="questionText"]').value.trim();
        const tipo = block.querySelector('select[name="answerType"]').value;

        if (!texto) return;

        const pregunta = {
          questionText: texto,
          answerType: tipo
        };

        if (tipo === 'multiple') {
          const opciones = Array.from(block.querySelectorAll('.option-input'))
                                .map(opt => opt.value.trim())
                                .filter(opt => opt !== '');
          if (opciones.length < 2) {
            alert("Cada pregunta de opción múltiple debe tener al menos 2 opciones.");
            return;
          }
          pregunta.options = opciones;
        }

        preguntas.push(pregunta);
      });

      if (preguntas.length === 0) {
        alert("Debes agregar al menos una pregunta.");
        return;
      }

      const payload = {
        nombreCuestionario: nombre,
        fechaCreacion: new Date().toISOString().split('T')[0],
        fechaApertura,
        fechaCierre,
        preguntas,
        Umbral
      };

      fetch('http://localhost:3000/guardar-cuestionario', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      })
      .then(res => res.json())
      .then(response => {
        if (response.exito) {
          alert("Cuestionario guardado exitosamente.");
          window.location.href = "AdministrarCuestionarios.html";
        } else {
          alert("Hubo un error al guardar el cuestionario.");
        }
      })
      .catch(err => {
        console.error("Error:", err);
        alert("Error al guardar el cuestionario.");
      });
    }
  </script>
</body>
</html>
